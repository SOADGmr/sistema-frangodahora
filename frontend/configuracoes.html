<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurações - Frango da Hora</title>
  <link rel="stylesheet" href="style.css" />
  <script src="auth.js"></script>
  <style>
    /* Estilo para o switch de Ativar/Desativar */
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #48bb78; }
    input:checked + .slider:before { transform: translateX(26px); }
    
    .automation-settings {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: #f7fafc;
      border-radius: 8px;
    }
    .setting-row span {
      font-weight: 500;
      color: #2d3748;
    }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="pedidos.html">Painel de Pedidos</a>
      <a href="motoqueiros.html">Painel de Entregas</a>
      <a href="configuracoes.html" class="active">Configurações</a>
      <a href="#" id="logout-btn" style="margin-left: auto; color: #e53e3e;">Sair</a>
    </nav>
  </header>

  <main>
    <div class="config-grid">
      <!-- Card para Taxas de Bairro -->
      <div class="config-card">
        <h3>Taxas de Entrega</h3>
        <p>Gerencie os bairros e suas respectivas taxas de entrega.</p>
        <button class="manage-btn" data-target="bairros-management-modal">Gerenciar</button>
      </div>
      
      <!-- Card para Usuários -->
      <div class="config-card">
        <h3>Usuários do Sistema</h3>
        <p>Adicione ou remova usuários com permissões de Admin ou Motoqueiro.</p>
        <button class="manage-btn" data-target="users-management-modal">Gerenciar</button>
      </div>

      <!-- Card para UaiRango -->
      <div class="config-card">
        <h3>Integração UaiRango</h3>
        <p>Conecte e gerencie seus estabelecimentos da plataforma UaiRango.</p>
        <button class="manage-btn" data-target="uairango-management-modal">Gerenciar</button>
      </div>

      <!-- Card para Automações -->
      <div class="config-card">
        <h3>Automações UaiRango</h3>
        <p>Ative ou desative regras automáticas para a integração com UaiRango.</p>
        <button class="manage-btn" data-target="automations-management-modal">Gerenciar</button>
      </div>
    </div>
  </main>

  <!-- MODAL DE GERENCIAMENTO: Taxas de Bairro -->
  <div id="bairros-management-modal" class="management-modal-container hidden">
    <div class="management-modal-content">
      <div class="management-modal-header">
        <h2>Taxas de Entrega por Bairro</h2>
        <div>
          <button id="add-bairro-btn" class="action-btn-header">Adicionar Bairro</button>
          <button class="close-management-modal-btn">&times;</button>
        </div>
      </div>
      <div class="management-modal-body">
        <div class="table-wrapper">
          <table id="bairrosTable">
            <thead><tr><th>Bairro</th><th>Taxa de Entrega</th><th>Ações</th></tr></thead>
            <tbody id="bairrosTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE GERENCIAMENTO: Usuários -->
  <div id="users-management-modal" class="management-modal-container hidden">
    <div class="management-modal-content">
      <div class="management-modal-header">
        <h2>Gerenciamento de Usuários</h2>
        <div>
          <button id="add-user-btn" class="action-btn-header">Adicionar Usuário</button>
          <button class="close-management-modal-btn">&times;</button>
        </div>
      </div>
      <div class="management-modal-body">
        <div class="table-wrapper">
          <table id="usersTable">
            <thead><tr><th>ID</th><th>Usuário</th><th>Cargo</th><th>Ações</th></tr></thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE GERENCIAMENTO: Integração UaiRango -->
  <div id="uairango-management-modal" class="management-modal-container hidden">
    <div class="management-modal-content">
      <div class="management-modal-header">
        <h2>Integração UaiRango</h2>
        <div>
          <button id="add-uairango-btn" class="action-btn-header">Adicionar Estabelecimento</button>
          <button class="close-management-modal-btn">&times;</button>
        </div>
      </div>
      <div class="management-modal-body">
        <div class="table-wrapper">
          <table id="uairangoTable">
            <thead><tr><th>Nome</th><th>ID Estabelecimento</th><th>Ativo</th><th>Ações</th></tr></thead>
            <tbody id="uairangoTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- MODAL DE GERENCIAMENTO: Automações UaiRango -->
  <div id="automations-management-modal" class="management-modal-container hidden">
    <div class="management-modal-content">
      <div class="management-modal-header">
        <h2>Automações UaiRango</h2>
        <button class="close-management-modal-btn">&times;</button>
      </div>
      <div class="management-modal-body">
        <div class="automation-settings">
          <div class="setting-row">
            <span>Fechar loja automaticamente quando estoque for menor que 1</span>
            <label class="switch">
              <input type="checkbox" id="toggle-auto-close">
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-row">
            <span>Rejeitar pedido automaticamente se a quantidade for maior que o estoque</span>
            <label class="switch">
              <input type="checkbox" id="toggle-auto-reject">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- MODAIS DE EDIÇÃO/CRIAÇÃO (flutuam sobre os modais de gerenciamento) -->
  <div id="bairro-modal" class="modal-container hidden">
    <section class="form-container" style="max-width: 500px;">
        <button id="close-bairro-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
        <h2 id="bairro-modal-title">Adicionar Novo Bairro</h2>
        <form id="bairro-form">
            <input type="hidden" id="bairro-id">
            <div class="form-field"><label for="bairro-nome">Nome do Bairro</label><input type="text" id="bairro-nome" required></div>
            <div class="form-field"><label for="bairro-taxa">Valor da Taxa (R$)</label><input type="number" id="bairro-taxa" min="0" step="0.01" required></div>
            <button type="submit">Salvar</button>
        </form>
    </section>
  </div>
  <div id="user-modal" class="modal-container hidden">
    <section class="form-container" style="max-width: 500px;">
        <button id="close-user-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
        <h2 id="user-modal-title">Adicionar Novo Usuário</h2>
        <form id="user-form">
            <div class="form-field"><label for="user-usuario">Nome de Usuário</label><input type="text" id="user-usuario" required></div>
            <div class="form-field"><label for="user-senha">Senha</label><input type="password" id="user-senha" required placeholder="Mínimo 6 caracteres"></div>
            <div class="form-field"><label for="user-cargo">Cargo</label><select id="user-cargo" required><option value="Admin">Administrador</option><option value="Moto">Motoqueiro</option></select></div>
            <button type="submit">Salvar</button>
        </form>
    </section>
  </div>
  <div id="uairango-modal" class="modal-container hidden">
    <section class="form-container" style="max-width: 500px;">
        <button id="close-uairango-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
        <h2>Adicionar Estabelecimento UaiRango</h2>
        <form id="uairango-form">
            <div class="form-field"><label for="uairango-nome">Nome (para sua referência)</label><input type="text" id="uairango-nome" required placeholder="Ex: Frango da Hora - Centro"></div>
            <div class="form-field"><label for="uairango-id">ID do Estabelecimento</label><input type="number" id="uairango-id" required></div>
            <div class="form-field"><label for="uairango-token">Token de Acesso (Developer Token)</label><input type="text" id="uairango-token" required></div>
            <button type="submit">Salvar</button>
        </form>
    </section>
  </div>


  <script>
    const usuarioLogado = checkAuth(['Admin']);
    const API_URL = '/api';
    let allBairros = [];

    const elements = {
        bairrosTbody: document.getElementById('bairrosTbody'),
        addBairroBtn: document.getElementById('add-bairro-btn'),
        bairroModal: document.getElementById('bairro-modal'),
        closeBairroModalBtn: document.getElementById('close-bairro-modal'),
        bairroForm: document.getElementById('bairro-form'),
        bairroModalTitle: document.getElementById('bairro-modal-title'),
        bairroIdInput: document.getElementById('bairro-id'),
        bairroNomeInput: document.getElementById('bairro-nome'),
        bairroTaxaInput: document.getElementById('bairro-taxa'),
        logoutBtn: document.getElementById('logout-btn'),
        usersTbody: document.getElementById('usersTbody'),
        addUserBtn: document.getElementById('add-user-btn'),
        userModal: document.getElementById('user-modal'),
        closeUserModalBtn: document.getElementById('close-user-modal'),
        userForm: document.getElementById('user-form'),
        userUsuarioInput: document.getElementById('user-usuario'),
        userSenhaInput: document.getElementById('user-senha'),
        userCargoSelect: document.getElementById('user-cargo'),
        uairangoTbody: document.getElementById('uairangoTbody'),
        addUairangoBtn: document.getElementById('add-uairango-btn'),
        uairangoModal: document.getElementById('uairango-modal'),
        closeUairangoModalBtn: document.getElementById('close-uairango-modal'),
        uairangoForm: document.getElementById('uairango-form'),
        uairangoNomeInput: document.getElementById('uairango-nome'),
        uairangoIdInput: document.getElementById('uairango-id'),
        uairangoTokenInput: document.getElementById('uairango-token'),
        toggleAutoClose: document.getElementById('toggle-auto-close'),
        toggleAutoReject: document.getElementById('toggle-auto-reject'),
    };

    const fetchJSON = async (url, options = {}) => {
      const response = await fetch(url, options);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Erro de comunicação' }));
        throw new Error(errorData.error);
      }
      const text = await response.text();
      return text ? JSON.parse(text) : { message: 'Operação bem-sucedida' };
    };

    // --- LÓGICA PARA BAIRROS ---
    const renderBairros = (bairros) => {
        allBairros = bairros;
        elements.bairrosTbody.innerHTML = bairros.map(b => `<tr><td>${b.bairro}</td><td>R$ ${b.taxa.toFixed(2)}</td><td><div class="action-buttons"><button class="action-btn edit-btn" data-id="${b.id}">Editar</button><button class="action-btn delete-btn" data-id="${b.id}">Excluir</button></div></td></tr>`).join('') || '<tr><td colspan="3">Nenhum bairro configurado.</td></tr>';
    };
    const loadBairros = async () => { try { renderBairros(await fetchJSON(`${API_URL}/configuracoes/taxas`)); } catch (e) { console.error(e); } };
    const openEditBairroModal = (id) => { const b = allBairros.find(b => b.id === id); if (b) { elements.bairroForm.reset(); elements.bairroIdInput.value = b.id; elements.bairroNomeInput.value = b.bairro; elements.bairroTaxaInput.value = b.taxa.toFixed(2); elements.bairroModalTitle.textContent = 'Editar Bairro'; elements.bairroModal.classList.remove('hidden'); } };
    const handleBairroFormSubmit = async (e) => { e.preventDefault(); const id = elements.bairroIdInput.value; const data = { bairro: elements.bairroNomeInput.value, taxa: parseFloat(elements.bairroTaxaInput.value) }; const method = id ? 'PUT' : 'POST'; const url = id ? `${API_URL}/configuracoes/taxas/${id}` : `${API_URL}/configuracoes/taxas`; try { await fetchJSON(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); elements.bairroModal.classList.add('hidden'); loadBairros(); } catch (error) { alert(`Erro: ${error.message}`); } };
    const handleBairroDelete = async (id) => { if (confirm('Excluir este bairro?')) { try { await fetchJSON(`${API_URL}/configuracoes/taxas/${id}`, { method: 'DELETE' }); loadBairros(); } catch (e) { alert(`Erro: ${e.message}`); } } };

    // --- LÓGICA PARA USUÁRIOS ---
    const renderUsers = (users) => {
        elements.usersTbody.innerHTML = users.map(u => { const delBtn = u.id === 1 ? `<button class="action-btn" disabled>Excluir</button>` : `<button class="action-btn delete-user-btn" data-id="${u.id}">Excluir</button>`; return `<tr><td>${u.id}</td><td>${u.usuario}</td><td>${u.cargo}</td><td><div class="action-buttons">${delBtn}</div></td></tr>`; }).join('') || '<tr><td colspan="4">Nenhum usuário cadastrado.</td></tr>';
    };
    const loadUsers = async () => { try { renderUsers(await fetchJSON(`${API_URL}/auth/users`)); } catch (e) { console.error(e); } };
    const handleUserFormSubmit = async (e) => { e.preventDefault(); const data = { usuario: elements.userUsuarioInput.value, senha: elements.userSenhaInput.value, cargo: elements.userCargoSelect.value }; if (data.senha.length < 6) { alert('Senha deve ter no mínimo 6 caracteres.'); return; } try { await fetchJSON(`${API_URL}/auth/users`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); elements.userModal.classList.add('hidden'); loadUsers(); } catch (e) { alert(`Erro: ${e.message}`); } };
    const handleUserDelete = async (id) => { if (confirm(`Excluir usuário ID ${id}?`)) { try { await fetchJSON(`${API_URL}/auth/users/${id}`, { method: 'DELETE' }); loadUsers(); } catch (e) { alert(`Erro: ${e.message}`); } } };

    // --- LÓGICA PARA UAIRANGO ---
    const renderUairango = (ests) => {
        elements.uairangoTbody.innerHTML = ests.map(e => `<tr><td>${e.nome_estabelecimento}</td><td>${e.id_estabelecimento}</td><td><label class="switch"><input type="checkbox" class="toggle-uairango-btn" data-id="${e.id}" ${e.ativo ? 'checked' : ''}><span class="slider"></span></label></td><td><div class="action-buttons"><button class="action-btn delete-uairango-btn" data-id="${e.id}">Excluir</button></div></td></tr>`).join('') || '<tr><td colspan="4">Nenhum estabelecimento configurado.</td></tr>';
    };
    const loadUairango = async () => { try { renderUairango(await fetchJSON(`${API_URL}/configuracoes/uairango`)); } catch (e) { console.error(e); } };
    const handleUairangoFormSubmit = async (e) => { e.preventDefault(); const data = { nome_estabelecimento: elements.uairangoNomeInput.value, id_estabelecimento: parseInt(elements.uairangoIdInput.value), token_developer: elements.uairangoTokenInput.value }; try { await fetchJSON(`${API_URL}/configuracoes/uairango`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); elements.uairangoModal.classList.add('hidden'); loadUairango(); } catch (e) { alert(`Erro: ${e.message}`); } };
    const handleUairangoDelete = async (id) => { if (confirm('Excluir esta configuração?')) { try { await fetchJSON(`${API_URL}/configuracoes/uairango/${id}`, { method: 'DELETE' }); loadUairango(); } catch (e) { alert(`Erro: ${e.message}`); } } };
    const handleUairangoToggle = async (id, ativo) => { try { await fetchJSON(`${API_URL}/configuracoes/uairango/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ativo: ativo ? 1 : 0 }) }); } catch (e) { alert(`Erro: ${e.message}`); loadUairango(); } };
    
    // --- LÓGICA PARA AUTOMAÇÕES ---
    const loadAutomations = async () => { try { const [ac, ar] = await Promise.all([ fetchJSON(`${API_URL}/configuracoes/uairango_auto_close`), fetchJSON(`${API_URL}/configuracoes/uairango_auto_reject`) ]); elements.toggleAutoClose.checked = ac.valor === '1'; elements.toggleAutoReject.checked = ar.valor === '1'; } catch (e) { console.error(e); } };
    const saveAutomation = async (key, value) => { try { await fetchJSON(`${API_URL}/configuracoes/${key}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ valor: value ? '1' : '0' }) }); } catch (e) { alert(`Erro ao salvar. A página será recarregada.`); location.reload(); } };

    // --- LÓGICA DOS MODAIS ---
    const openManagementModal = (id) => { const modal = document.getElementById(id); if (modal) modal.classList.remove('hidden'); };
    const closeAllManagementModals = () => document.querySelectorAll('.management-modal-container').forEach(m => m.classList.add('hidden'));

    function setupEventListeners() {
        elements.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); logout(); });
        
        // Listeners para abrir os modais de gerenciamento
        document.querySelectorAll('.manage-btn').forEach(btn => btn.addEventListener('click', () => openManagementModal(btn.dataset.target)));
        // Listeners para fechar os modais de gerenciamento
        document.querySelectorAll('.close-management-modal-btn').forEach(btn => btn.addEventListener('click', closeAllManagementModals));

        // Bairros
        elements.addBairroBtn.addEventListener('click', () => { elements.bairroForm.reset(); elements.bairroIdInput.value = ''; elements.bairroModalTitle.textContent = 'Adicionar Novo Bairro'; elements.bairroModal.classList.remove('hidden'); });
        elements.closeBairroModalBtn.addEventListener('click', () => elements.bairroModal.classList.add('hidden'));
        elements.bairroForm.addEventListener('submit', handleBairroFormSubmit);
        elements.bairrosTbody.addEventListener('click', (e) => { const t = e.target.closest('.action-btn'); if (!t) return; const id = parseInt(t.dataset.id); if (t.classList.contains('delete-btn')) handleBairroDelete(id); if (t.classList.contains('edit-btn')) openEditBairroModal(id); });
        
        // Usuários
        elements.addUserBtn.addEventListener('click', () => { elements.userForm.reset(); elements.userModal.classList.remove('hidden'); });
        elements.closeUserModalBtn.addEventListener('click', () => elements.userModal.classList.add('hidden'));
        elements.userForm.addEventListener('submit', handleUserFormSubmit);
        elements.usersTbody.addEventListener('click', (e) => { const t = e.target.closest('.action-btn'); if (t && t.classList.contains('delete-user-btn') && !t.disabled) handleUserDelete(parseInt(t.dataset.id)); });
        
        // UaiRango
        elements.addUairangoBtn.addEventListener('click', () => { elements.uairangoForm.reset(); elements.uairangoModal.classList.remove('hidden'); });
        elements.closeUairangoModalBtn.addEventListener('click', () => elements.uairangoModal.classList.add('hidden'));
        elements.uairangoForm.addEventListener('submit', handleUairangoFormSubmit);
        elements.uairangoTbody.addEventListener('click', (e) => { const t = e.target; if (t.classList.contains('delete-uairango-btn')) handleUairangoDelete(parseInt(t.dataset.id)); if (t.classList.contains('toggle-uairango-btn')) handleUairangoToggle(parseInt(t.dataset.id), t.checked); });
        
        // Automações
        elements.toggleAutoClose.addEventListener('change', (e) => saveAutomation('uairango_auto_close', e.target.checked));
        elements.toggleAutoReject.addEventListener('change', (e) => saveAutomation('uairango_auto_reject', e.target.checked));
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        loadBairros();
        loadUsers();
        loadUairango();
        loadAutomations();
    });
  </script>

</body>
</html>

