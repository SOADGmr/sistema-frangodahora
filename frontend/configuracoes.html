<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurações - Frangolândia</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <nav>
      <a href="index.html">Painel de Pedidos</a>
      <a href="motoqueiros.html">Painel de Entregas</a>
      <a href="configuracoes.html" class="active">Configurações</a>
    </nav>
  </header>

  <main>
    <div class="pedidos-container">
      <div class="info-header" style="margin-bottom: 1.5rem;">
        <h2>Taxas de Entrega por Bairro</h2>
        <button id="add-bairro-btn" class="action-btn-header">Adicionar Bairro</button>
      </div>
      <div class="table-wrapper">
        <table id="bairrosTable">
          <thead>
            <tr>
              <th>Bairro</th>
              <th>Taxa de Entrega</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="bairrosTbody">
            <!-- Linhas da tabela serão inseridas aqui -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODAL PARA ADICIONAR/EDITAR BAIRRO -->
  <div id="bairro-modal" class="modal-container hidden">
    <section class="form-container" style="max-width: 500px;">
        <button id="close-bairro-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
        <h2 id="bairro-modal-title">Adicionar Novo Bairro</h2>
        <form id="bairro-form">
            <input type="hidden" id="bairro-id">
            <div class="form-field">
                <label for="bairro-nome">Nome do Bairro</label>
                <input type="text" id="bairro-nome" required>
            </div>
            <div class="form-field">
                <label for="bairro-taxa">Valor da Taxa (R$)</label>
                <input type="number" id="bairro-taxa" min="0" step="0.01" required>
            </div>
            <button type="submit">Salvar</button>
        </form>
    </section>
  </div>

  <script>
    const API_URL = '/api';

    const elements = {
        bairrosTbody: document.getElementById('bairrosTbody'),
        addBairroBtn: document.getElementById('add-bairro-btn'),
        bairroModal: document.getElementById('bairro-modal'),
        closeBairroModalBtn: document.getElementById('close-bairro-modal'),
        bairroForm: document.getElementById('bairro-form'),
        bairroModalTitle: document.getElementById('bairro-modal-title'),
        bairroIdInput: document.getElementById('bairro-id'),
        bairroNomeInput: document.getElementById('bairro-nome'),
        bairroTaxaInput: document.getElementById('bairro-taxa'),
    };

    const fetchJSON = async (url, options = {}) => {
      const response = await fetch(url, options);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Erro de comunicação' }));
        throw new Error(errorData.error);
      }
      const text = await response.text();
      return text ? JSON.parse(text) : { message: 'Operação bem-sucedida' };
    };

    const renderBairros = (bairros) => {
        elements.bairrosTbody.innerHTML = '';
        if (bairros.length === 0) {
            elements.bairrosTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem;">Nenhum bairro configurado.</td></tr>';
            return;
        }
        bairros.forEach(bairro => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${bairro.bairro}</td>
                <td>R$ ${bairro.taxa.toFixed(2)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn delete-btn" data-id="${bairro.id}">Excluir</button>
                    </div>
                </td>
            `;
            elements.bairrosTbody.appendChild(tr);
        });
    };

    const loadBairros = async () => {
        try {
            const bairros = await fetchJSON(`${API_URL}/configuracoes/taxas`);
            renderBairros(bairros);
        } catch (error) {
            console.error('Erro ao carregar bairros:', error);
            alert('Não foi possível carregar as taxas dos bairros.');
        }
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        const id = elements.bairroIdInput.value;
        const bairro = {
            bairro: elements.bairroNomeInput.value,
            taxa: parseFloat(elements.bairroTaxaInput.value)
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/configuracoes/taxas/${id}` : `${API_URL}/configuracoes/taxas`;

        try {
            await fetchJSON(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bairro)
            });
            elements.bairroModal.classList.add('hidden');
            loadBairros();
        } catch (error) {
            alert(`Erro ao salvar bairro: ${error.message}`);
        }
    };

    const handleDelete = async (id) => {
        if (confirm('Tem certeza que deseja excluir este bairro?')) {
            try {
                await fetchJSON(`${API_URL}/configuracoes/taxas/${id}`, { method: 'DELETE' });
                loadBairros();
            } catch (error) {
                alert(`Erro ao excluir bairro: ${error.message}`);
            }
        }
    };

    function setupEventListeners() {
        elements.addBairroBtn.addEventListener('click', () => {
            elements.bairroForm.reset();
            elements.bairroIdInput.value = '';
            elements.bairroModalTitle.textContent = 'Adicionar Novo Bairro';
            elements.bairroModal.classList.remove('hidden');
        });

        elements.closeBairroModalBtn.addEventListener('click', () => {
            elements.bairroModal.classList.add('hidden');
        });

        elements.bairroModal.addEventListener('click', (e) => {
            if (e.target === elements.bairroModal) {
                elements.bairroModal.classList.add('hidden');
            }
        });

        elements.bairroForm.addEventListener('submit', handleFormSubmit);

        elements.bairrosTbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                handleDelete(id);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        loadBairros();
    });
  </script>

</body>
</html>
