<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minhas Entregas - Frango da Hora</title>
  <link rel="stylesheet" href="style.css" />
  <script src="auth.js"></script>
</head>
<body class="cliente-page">

  <main id="deliveries-view" class="container">
    <div class="deliveries-header">
      <h1 id="motoqueiro-name-display">Carregando...</h1>
      <div class="header-actions">
        <button id="pix-btn" class="pix-btn">QR CODE PIX</button>
        <button id="logout-btn" class="logout-btn">Sair</button>
      </div>
    </div>

    <div id="deliveries-list">
        </div>
  </main>
  
  <div id="pix-modal" class="modal-container hidden">
      <section class="modal-content">
          <button id="close-pix-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
          <h2>Pagamento com PIX</h2>
          <p>Aponte a c√¢mera do seu celular para o QR Code abaixo.</p>
          <img src="./imagens/qr_code_pix.jpg" alt="QR Code PIX" style="max-width: 100%; height: auto;">
      </section>
  </div>


  <script>
    // 1. Garante que apenas usu√°rios do tipo 'Moto' acessem a p√°gina
    const usuarioLogado = checkAuth(['Moto']);
    
    const API_URL = '/api';
    let prazoUpdateInterval;

    const elements = {
        deliveriesView: document.getElementById('deliveries-view'),
        motoqueiroNameDisplay: document.getElementById('motoqueiro-name-display'),
        deliveriesList: document.getElementById('deliveries-list'),
        logoutBtn: document.getElementById('logout-btn'),
        pixBtn: document.getElementById('pix-btn'),
        pixModal: document.getElementById('pix-modal'),
        closePixModalBtn: document.getElementById('close-pix-modal'),
    };

    const fetchJSON = async (url, options = {}) => {
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Erro de comunica√ß√£o' }));
            throw new Error(errorData.error);
        }
        const text = await response.text();
        return text ? JSON.parse(text) : { message: 'Opera√ß√£o bem-sucedida' };
    };
    
    const calcularPrazo = (horarioPedido, tempoPrevisto) => {
        if (!horarioPedido || !tempoPrevisto) return '---';

        const agora = new Date();
        const horaPedidoDate = new Date(horarioPedido);
        const horaPrevista = new Date(horaPedidoDate.getTime() + tempoPrevisto * 60000);

        const diff = horaPrevista - agora;
        const isAtrasado = diff < 0;
        const diffAbs = Math.abs(diff);

        const horas = Math.floor(diffAbs / (1000 * 60 * 60));
        const minutos = Math.floor((diffAbs % (1000 * 60 * 60)) / (1000 * 60));

        const hFormat = String(horas).padStart(2, '0');
        const mFormat = String(minutos).padStart(2, '0');
        
        const classe = isAtrasado ? 'prazo-atrasado' : 'prazo-ok';
        const sinal = isAtrasado ? '-' : '';

        return `<span class="prazo ${classe}">${sinal}${hFormat}:${mFormat}</span>`;
    };

    const renderDeliveries = (motoqueiro) => {
        elements.motoqueiroNameDisplay.textContent = `Ol√°, ${motoqueiro.nome}!`;
        elements.deliveriesList.innerHTML = '';
        
        if (motoqueiro.pedidos_em_rota.length === 0) {
            elements.deliveriesList.innerHTML += '<div class="no-deliveries">Nenhuma entrega em rota no momento.</div>';
        } else {
            motoqueiro.pedidos_em_rota.forEach(p => {
                const card = createDeliveryCard(p, false);
                elements.deliveriesList.innerHTML += card;
            });
        }

        if (motoqueiro.pedidos_entregues.length > 0) {
            elements.deliveriesList.innerHTML += '<h2 class="deliveries-section-title">Entregas Finalizadas</h2>';
            motoqueiro.pedidos_entregues.forEach(p => {
                const card = createDeliveryCard(p, true);
                elements.deliveriesList.innerHTML += card;
            });
        }
        startPrazoUpdater();
    };

    const createDeliveryCard = (pedido, isEntregue) => {
        const totalFrangos = pedido.quantidade_frangos + (pedido.meio_frango ? 0.5 : 0);
        const gmapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(pedido.cliente_endereco + ', ' + pedido.cliente_bairro)}`;
        const prazoHtml = !isEntregue ? calcularPrazo(pedido.horario_pedido, pedido.tempo_previsto) : '---';

        return `
        <div class="delivery-card ${isEntregue ? 'card-entregue' : ''}" data-pedido-id="${pedido.id}" data-horario-pedido="${pedido.horario_pedido}" data-tempo-previsto="${pedido.tempo_previsto}">
            <div class="card-header">
                <h3>üêî ${totalFrangos} | #${pedido.id} ${pedido.cliente_nome}</h3>
                <strong class="prazo-cell">${prazoHtml}</strong>
            </div>
            <div class="card-body">
                <p><strong>Endere√ßo:</strong> ${pedido.cliente_endereco}, ${pedido.cliente_bairro}</p>
                ${pedido.cliente_referencia ? `<p><strong>Refer√™ncia:</strong> ${pedido.cliente_referencia}</p>` : ''}
                ${pedido.observacao ? `<p><strong>Observa√ß√£o:</strong> ${pedido.observacao}</p>` : ''}
                <div class="card-body-footer">
                    <p><strong>Pagamento:</strong> ${pedido.forma_pagamento} - <strong>R$ ${pedido.preco_total.toFixed(2)}</strong></p>
                    <div class="card-delivery-controls">
                        <a href="${gmapsLink}" target="_blank" class="map-btn" title="Ver no Google Maps">
                            <svg fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        </a>
                        <a href="tel:${pedido.cliente_telefone}" class="map-btn" style="background-color: #38a169;" title="Ligar para o cliente">
                            <svg fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-actions">
                <button class="btn btn-entregue" data-id="${pedido.id}" ${isEntregue ? 'disabled' : ''}>Marcar como Entregue</button>
            </div>
        </div>`;
    };
    
    const startPrazoUpdater = () => {
        if (prazoUpdateInterval) clearInterval(prazoUpdateInterval);
        prazoUpdateInterval = setInterval(() => {
            document.querySelectorAll('.delivery-card:not(.card-entregue)').forEach(card => {
                const prazoCell = card.querySelector('.prazo-cell');
                if (prazoCell) {
                    prazoCell.innerHTML = calcularPrazo(card.dataset.horarioPedido, card.dataset.tempoPrevisto);
                }
            });
        }, 30000); // Atualiza a cada 30 segundos
    };

    const loadMotoqueiroData = async (nome) => {
        try {
            const data = await fetchJSON(`${API_URL}/motoqueiros/nome/${nome}`);
            if (data) {
                renderDeliveries(data);
            } else {
                 elements.deliveriesList.innerHTML = '<div class="no-deliveries">N√£o foi poss√≠vel carregar suas entregas. Verifique se seu dia foi iniciado pelo administrador.</div>';
            }
        } catch (error) {
            elements.motoqueiroNameDisplay.textContent = 'Erro';
            elements.deliveriesList.innerHTML = `<div class="no-deliveries">Erro ao carregar dados: ${error.message}</div>`;
        }
    };
    
    const handleMarkAsDelivered = async (pedidoId) => { 
        if (confirm(`Confirmar a entrega do pedido #${pedidoId}?`)) { 
            try { 
                await fetchJSON(`${API_URL}/pedidos/${pedidoId}/entregar`, { method: 'PUT' }); 
                // Recarrega os dados para atualizar a tela
                loadMotoqueiroData(usuarioLogado.usuario);
            } catch (error) { 
                alert(`Erro ao finalizar entrega: ${error.message}`); 
            } 
        } 
    };

    function setupEventListeners() {
        elements.logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });

        elements.pixBtn.addEventListener('click', () => {
            elements.pixModal.classList.remove('hidden');
        });

        elements.closePixModalBtn.addEventListener('click', () => {
            elements.pixModal.classList.add('hidden');
        });
        
        elements.pixModal.addEventListener('click', (e) => {
            if (e.target === elements.pixModal) {
                 elements.pixModal.classList.add('hidden');
            }
        });

        elements.deliveriesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-entregue')) {
                handleMarkAsDelivered(e.target.dataset.id);
            }
        });
    }

    // --- Fun√ß√£o Principal de Inicializa√ß√£o ---
    function initializePage() {
        // Se o usu√°rio est√° logado (verificado pelo checkAuth), carrega seus dados
        if (usuarioLogado && usuarioLogado.usuario) {
            setupEventListeners();
            loadMotoqueiroData(usuarioLogado.usuario);
        } else {
            // Caso algo d√™ errado com a autentica√ß√£o, mostra uma mensagem
            elements.deliveriesView.innerHTML = '<div class="no-deliveries">Erro de autentica√ß√£o. Por favor, fa√ßa o login novamente.</div>';
        }
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>

</body>
</html>