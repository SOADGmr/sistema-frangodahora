<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Minhas Entregas</title>
  <link rel="stylesheet" href="style.css" />
  <!-- NOVO: Script de autenticação -->
  <script src="auth.js"></script>
</head>
<body>

  <!-- A TELA DE LOGIN FOI REMOVIDA DAQUI -->

  <div id="app-container" class="container">
    <!-- TELA DE ENTREGAS (agora sempre visível se autenticado) -->
    <div id="deliveries-view">
      <div class="deliveries-header">
        <h2 id="welcome-message"></h2>
        <div class="header-actions">
            <button id="pix-btn" class="pix-btn">PIX</button>
            <button id="logout-btn" class="logout-btn">Sair</button>
        </div>
      </div>
      <div id="deliveries-list"></div>
    </div>
  </div>

  <!-- MODAL DO PIX -->
  <div id="pix-modal" class="modal-container hidden">
      <div class="modal-content">
          <h2>QR Code PIX</h2>
          <!-- Substitua pela imagem real do seu QR Code -->
          <img src="./imagens/qr_code_pix.jpg" alt="QR Code Pix" style="max-width: 100%; border-radius: 8px;">
          <button id="close-pix-modal" class="btn" style="margin-top: 1rem;">Fechar</button>
      </div>
  </div>

  <script>
    // NOVO: Verifica se o usuário é do tipo 'Moto'
    const usuarioLogado = checkAuth(['Moto']);

    const API_URL = '/api';
    let prazoUpdateInterval;

    const elements = {
      // loginView e outros elementos de login foram removidos
      deliveriesView: document.getElementById('deliveries-view'),
      welcomeMessage: document.getElementById('welcome-message'),
      logoutBtn: document.getElementById('logout-btn'),
      deliveriesList: document.getElementById('deliveries-list'),
      pixBtn: document.getElementById('pix-btn'),
      pixModal: document.getElementById('pix-modal'),
      closePixModalBtn: document.getElementById('close-pix-modal'),
    };

    const fetchJSON = async (url, options = {}) => {
      const response = await fetch(url, options);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Erro de comunicação' }));
        throw new Error(errorData.error);
      }
      return response.json();
    };
    
    const calcularPrazo = (horarioPedido, tempoPrevisto) => {
        if (!horarioPedido || !tempoPrevisto) return '---';

        const agora = new Date();
        const horaPedidoDate = new Date(horarioPedido);
        const horaPrevista = new Date(horaPedidoDate.getTime() + tempoPrevisto * 60000);

        const diff = horaPrevista - agora;
        const isAtrasado = diff < 0;
        const diffAbs = Math.abs(diff);

        const horas = Math.floor(diffAbs / (1000 * 60 * 60));
        const minutos = Math.floor((diffAbs % (1000 * 60 * 60)) / (1000 * 60));

        const hFormat = String(horas).padStart(2, '0');
        const mFormat = String(minutos).padStart(2, '0');
        
        const classe = isAtrasado ? 'prazo-atrasado' : 'prazo-ok';
        const sinal = isAtrasado ? '-' : '';

        return `<span class="prazo ${classe}">${sinal}${hFormat}:${mFormat}</span>`;
    };

    const createDeliveryCard = (pedido, isDelivered) => {
        const card = document.createElement('div');
        card.className = 'delivery-card';
        if (isDelivered) {
            card.classList.add('card-entregue');
        }
        
        card.dataset.horarioPedido = pedido.horario_pedido;
        card.dataset.tempoPrevisto = pedido.tempo_previsto;
        card.dataset.pedidoId = pedido.id;

        const picadoClass = pedido.picado ? 'sim' : 'nao';
        const fullAddress = `${pedido.cliente_endereco}, ${pedido.cliente_bairro}`;
        const encodedAddress = encodeURIComponent(fullAddress);
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
        const totalFrangos = pedido.quantidade_frangos + (pedido.meio_frango ? 0.5 : 0);

        const buttonHtml = isDelivered 
            ? `<button class="btn btn-entregue" disabled>Entregue</button>`
            : `<button class="btn btn-entregue" data-pedido-id="${pedido.id}">Marcar como Entregue</button>`;
            
        const prazoHtml = isDelivered ? '' : calcularPrazo(pedido.horario_pedido, pedido.tempo_previsto);

        card.innerHTML = `
          <div class="card-header">
            <h3>
              <span class="picado-tag ${picadoClass}" title="${pedido.picado ? 'Frango Picado' : 'Frango Inteiro'}"></span>
              #${pedido.id} - ${pedido.cliente_nome}
            </h3>
            <div style="text-align: right;">
                <strong>R$ ${pedido.preco_total.toFixed(2)}</strong>
                <div class="prazo-cell">${prazoHtml}</div>
            </div>
          </div>
          <div class="card-body">
            <p><strong>Endereço:</strong> ${pedido.cliente_endereco}, ${pedido.cliente_bairro}</p>
            ${pedido.cliente_referencia ? `<p><strong>Referência:</strong> ${pedido.cliente_referencia}</p>` : ''}
            <p><strong>Telefone:</strong> ${pedido.cliente_telefone}</p>
            ${pedido.observacao ? `<p><strong>Obs:</strong> ${pedido.observacao}</p>` : ''}
            <div class="card-body-footer">
                <p><strong>Pagamento:</strong> ${pedido.forma_pagamento}</p>
                <div class="card-delivery-controls">
                    <a href="${mapsUrl}" target="_blank" class="map-btn" title="Ver no mapa">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    </a>
                    <div class="qty-display">${totalFrangos}</div>
                </div>
            </div>
          </div>
          <div class="card-actions">
            ${buttonHtml}
          </div>
        `;
        return card;
    };

    const renderDeliveries = (motoqueiro) => {
      elements.deliveriesList.innerHTML = '';
      const hasPendingDeliveries = motoqueiro.pedidos_em_rota && motoqueiro.pedidos_em_rota.length > 0;
      const hasFinishedDeliveries = motoqueiro.pedidos_entregues && motoqueiro.pedidos_entregues.length > 0;

      if (!hasPendingDeliveries && !hasFinishedDeliveries) {
        elements.deliveriesList.innerHTML = '<p class="no-deliveries">Nenhuma entrega no momento. Bom descanso!</p>';
        return;
      }

      if (hasPendingDeliveries) {
        motoqueiro.pedidos_em_rota.forEach(pedido => {
            const card = createDeliveryCard(pedido, false);
            elements.deliveriesList.appendChild(card);
        });
      }

      if (hasFinishedDeliveries) {
        const finishedTitle = document.createElement('h3');
        finishedTitle.className = 'deliveries-section-title';
        finishedTitle.textContent = 'Entregas Finalizadas';
        elements.deliveriesList.appendChild(finishedTitle);

        motoqueiro.pedidos_entregues.forEach(pedido => {
            const card = createDeliveryCard(pedido, true);
            elements.deliveriesList.appendChild(card);
        });
      }
      startPrazoUpdater();
    };

    const startPrazoUpdater = () => {
        if (prazoUpdateInterval) clearInterval(prazoUpdateInterval);
        prazoUpdateInterval = setInterval(() => {
            document.querySelectorAll('#deliveries-list .delivery-card[data-pedido-id]').forEach(card => {
                if (!card.classList.contains('card-entregue')) {
                    const prazoCell = card.querySelector('.prazo-cell');
                    if (prazoCell) {
                        prazoCell.innerHTML = calcularPrazo(card.dataset.horarioPedido, card.dataset.tempoPrevisto);
                    }
                }
            });
        }, 60000);
    };
    
    const handleMarkAsDelivered = async (e) => {
      if (!e.target.classList.contains('btn-entregue') || e.target.disabled) return;
      const pedidoId = e.target.dataset.pedidoId;
      if (confirm(`Confirmar a entrega do pedido #${pedidoId}?`)) {
        try {
          await fetchJSON(`${API_URL}/pedidos/${pedidoId}/entregar`, { method: 'PUT' });
          loadMotoqueiroData(); // Recarrega os dados
        } catch (error) {
          alert(`Erro ao confirmar entrega: ${error.message}`);
        }
      }
    };

    const loadMotoqueiroData = async () => {
        try {
            // Usa o nome de usuário do objeto 'usuarioLogado'
            const motoqueiro = await fetchJSON(`${API_URL}/motoqueiros/nome/${encodeURIComponent(usuarioLogado.usuario)}`);
            elements.welcomeMessage.textContent = `Olá, ${motoqueiro.nome.split(' ')[0]}!`;
            renderDeliveries(motoqueiro);
        } catch (error) {
            alert(`Erro ao carregar seus dados: ${error.message}`);
            logout(); // Se der erro, desloga o usuário
        }
    };

    const setupEventListeners = () => {
        elements.logoutBtn.addEventListener('click', logout);
        elements.deliveriesList.addEventListener('click', handleMarkAsDelivered);
        elements.pixBtn.addEventListener('click', () => elements.pixModal.classList.remove('hidden'));
        elements.closePixModalBtn.addEventListener('click', () => elements.pixModal.classList.add('hidden'));
        elements.pixModal.addEventListener('click', (e) => { if(e.target === elements.pixModal) elements.pixModal.classList.add('hidden'); });
    };

    // Função de inicialização da página
    const init = () => {
        // A verificação já foi feita. Agora carregamos os dados.
        loadMotoqueiroData();
        setupEventListeners();
    };

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
