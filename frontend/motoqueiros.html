<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Entregas - Frangolândia</title>
  <link rel="stylesheet" href="style.css" />
  <script src="auth.js"></script>
</head>
<body class="motoqueiros-page"> <!-- CLASSE ADICIONADA -->

  <header>
    <nav>
      <a href="pedidos.html">Painel de Pedidos</a>
      <a href="motoqueiros.html" class="active">Painel de Entregas</a>
      <a href="configuracoes.html">Configurações</a>
      <a href="#" id="logout-btn" style="margin-left: auto; color: #e53e3e;">Sair</a>
    </nav>
    <div class="info-header">
        <div class="date-navigator">
            <button id="prev-day-btn" class="date-nav-btn">&lt;</button>
            <span id="current-date-display"></span>
            <button id="next-day-btn" class="date-nav-btn">&gt;</button>
        </div>
        <div class="header-actions">
            <button id="open-start-day-modal-btn" class="action-btn-header">Iniciar Dia de Motoqueiro</button>
        </div>
    </div>
  </header>

  <main class="page-container">
    <div id="motoqueiros-list" class="motoqueiros-panel">
        <!-- Os cards dos motoqueiros serão inseridos aqui pelo JavaScript -->
    </div>

    <!-- ESTRUTURA DO PAINEL DE PEDIDOS SIMPLIFICADA -->
    <div class="orders-panel">
        <h2>Pedidos do Dia</h2>
        <div class="form-field"><input type="text" id="search-pedidos" placeholder="Pesquisar por cliente ou bairro..."></div>
        <ul id="all-orders-list" class="pedidos-list"></ul>
    </div>
  </main>

  <!-- MODAL PARA INICIAR O DIA DO MOTOQUEIRO -->
  <div id="start-day-modal" class="modal-container hidden">
    <section class="form-container" style="max-width: 500px;">
        <button id="close-start-day-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
        <h2>Iniciar Dia do Motoqueiro</h2>
        <form id="start-day-form">
            <div class="form-field">
                <label for="motoqueiro-nome-start">Nome do Motoqueiro</label>
                <input type="text" id="motoqueiro-nome-start" list="motoqueiros-datalist" placeholder="Digite ou selecione um nome" required>
                <datalist id="motoqueiros-datalist"></datalist>
            </div>
            <div class="form-field">
                <label for="frangos-na-bag-start">Frangos Iniciais na Bag</label>
                <input type="number" id="frangos-na-bag-start" min="0" step="0.5" required>
            </div>
            <button type="submit">Confirmar Início</button>
        </form>
    </section>
  </div>

  <!-- MODAL PARA AJUSTAR FRANGOS NA BAG -->
  <div id="adjust-chicken-modal" class="modal-container hidden">
    <section class="form-container" style="max-width: 500px;">
        <button id="close-adjust-chicken-modal" class="close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
        <h2 id="adjust-modal-title">Ajustar Frangos</h2>
        <form id="adjust-chicken-form">
            <div class="form-field">
                <label for="adjust-chicken-amount">Quantidade</label>
                <input type="number" id="adjust-chicken-amount" min="0" step="0.5" required>
            </div>
            <button type="submit">Confirmar</button>
        </form>
    </section>
  </div>

  <!-- MODAL DE DETALHES DO MOTOQUEIRO -->
  <div id="details-modal" class="modal-container hidden">
    <section class="form-container">
        <div id="details-modal-header"></div>
        <ul id="details-pedidos-list" class="pedidos-list"></ul>
        <div id="details-modal-footer"></div>
    </section>
  </div>

  <script>
    const usuarioLogado = checkAuth(['Admin']);
  
    const API_URL = '/api';
    let selectedDate = new Date();
    let allPedidos = [];
    let activeMotoqueiros = []; 
    let masterMotoqueiros = []; 
    let modalPrazoInterval;

    const elements = {
        motoqueirosList: document.getElementById('motoqueiros-list'),
        allOrdersList: document.getElementById('all-orders-list'),
        startDayForm: document.getElementById('start-day-form'),
        motoqueiroNomeStart: document.getElementById('motoqueiro-nome-start'),
        motoqueirosDatalist: document.getElementById('motoqueiros-datalist'),
        frangosNaBagStartInput: document.getElementById('frangos-na-bag-start'),
        searchPedidosInput: document.getElementById('search-pedidos'),
        detailsModal: document.getElementById('details-modal'),
        detailsModalHeader: document.getElementById('details-modal-header'),
        detailsPedidosList: document.getElementById('details-pedidos-list'),
        detailsModalFooter: document.getElementById('details-modal-footer'),
        currentDateDisplay: document.getElementById('current-date-display'),
        prevDayBtn: document.getElementById('prev-day-btn'),
        nextDayBtn: document.getElementById('next-day-btn'),
        openStartDayModalBtn: document.getElementById('open-start-day-modal-btn'),
        startDayModal: document.getElementById('start-day-modal'),
        closeStartDayModalBtn: document.getElementById('close-start-day-modal'),
        adjustChickenModal: document.getElementById('adjust-chicken-modal'),
        closeAdjustChickenModalBtn: document.getElementById('close-adjust-chicken-modal'),
        adjustChickenForm: document.getElementById('adjust-chicken-form'),
        adjustModalTitle: document.getElementById('adjust-modal-title'),
        adjustChickenAmountInput: document.getElementById('adjust-chicken-amount'),
        logoutBtn: document.getElementById('logout-btn'),
    };

    const formatDateToYYYYMMDD = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const formatDisplayDate = (date) => {
        const today = new Date();
        if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(today)) {
            return "Hoje";
        }
        const day = String(date.getDate()).padStart(2, '0');
        const month = date.toLocaleString('pt-BR', { month: 'short' }).toUpperCase().replace('.', '');
        return `${day}/${month}`;
    };
    
    const calcularPrazo = (horarioPedido, tempoPrevisto) => {
        if (!horarioPedido || !tempoPrevisto) return '---';

        const agora = new Date();
        const horaPedidoDate = new Date(horarioPedido);
        const horaPrevista = new Date(horaPedidoDate.getTime() + tempoPrevisto * 60000);

        const diff = horaPrevista - agora;
        const isAtrasado = diff < 0;
        const diffAbs = Math.abs(diff);

        const horas = Math.floor(diffAbs / (1000 * 60 * 60));
        const minutos = Math.floor((diffAbs % (1000 * 60 * 60)) / (1000 * 60));

        const hFormat = String(horas).padStart(2, '0');
        const mFormat = String(minutos).padStart(2, '0');
        
        const classe = isAtrasado ? 'prazo-atrasado' : 'prazo-ok';
        const sinal = isAtrasado ? '-' : '';

        return `<span class="prazo ${classe}">${sinal}${hFormat}:${mFormat}</span>`;
    };

    const updateDateDisplay = () => { elements.currentDateDisplay.textContent = formatDisplayDate(selectedDate); };
    const fetchJSON = async (url, options = {}) => { const response = await fetch(url, options); if (!response.ok) { const errorData = await response.json().catch(() => ({ error: 'Erro de comunicação' })); throw new Error(errorData.error); } const text = await response.text(); return text ? JSON.parse(text) : { message: 'Operação bem-sucedida' }; };

    const renderMotoqueiros = () => {
        elements.motoqueirosList.innerHTML = '';
        activeMotoqueiros.forEach(m => {
            const card = document.createElement('div');
            card.className = 'motoqueiro-card';
            card.dataset.motoqueiroId = m.id;
            const frangosEntregues = m.pedidos_entregues.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const frangosAtribuidos = m.pedidos_em_rota.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const frangosDisponiveis = m.frangos_na_bag - frangosAtribuidos - frangosEntregues;
            let squaresHtml = '';
            for(let i = 0; i < Math.floor(frangosEntregues); i++) { squaresHtml += `<div class="chicken-square square-delivered"></div>`; }
            for(let i = 0; i < Math.floor(frangosAtribuidos); i++) { squaresHtml += `<div class="chicken-square square-assigned"></div>`; }
            for(let i = 0; i < Math.floor(frangosDisponiveis); i++) { squaresHtml += `<div class="chicken-square square-available"></div>`; }
            
            card.innerHTML = `
                <div class="motoqueiro-card-content">
                    <div class="motoqueiro-info-wrapper">
                        <h3 class="motoqueiro-name">${m.nome}</h3>
                        <span class="bag-info">Bag: ${frangosDisponiveis} / ${m.frangos_na_bag} frangos</span>
                    </div>
                    <div class="adjust-buttons">
                        <button class="adjust-btn add" data-motoqueiro-nome="${m.nome}" data-action="add">+</button>
                        <button class="adjust-btn remove" data-motoqueiro-nome="${m.nome}" data-action="remove">-</button>
                    </div>
                    <div class="chicken-squares">${squaresHtml}</div>
                </div>
            `;
            elements.motoqueirosList.appendChild(card);
        });
    };

    const renderAllPedidos = (searchTerm = '') => {
        elements.allOrdersList.innerHTML = '';
        let deliveryOrders = allPedidos.filter(p => p.cliente_endereco !== 'Retirada');
        if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            deliveryOrders = deliveryOrders.filter(p => 
                (p.cliente_nome && p.cliente_nome.toLowerCase().includes(lowerCaseSearchTerm)) || 
                (p.cliente_bairro && p.cliente_bairro.toLowerCase().includes(lowerCaseSearchTerm))
            );
        }
        if (deliveryOrders.length === 0) {
            elements.allOrdersList.innerHTML = '<div class="no-pedidos">Nenhum pedido de entrega encontrado.</div>';
            return;
        }
        deliveryOrders.forEach(p => {
            const li = document.createElement('li');
            const isDraggable = p.status === 'Pendente';
            li.className = `pedido-item ${isDraggable ? 'draggable' : ''}`;
            li.draggable = isDraggable;
            li.dataset.pedidoId = p.id;
            const totalFrangos = p.quantidade_frangos + (p.meio_frango ? 0.5 : 0);
            li.dataset.pedidoQtd = totalFrangos;
            const statusClass = p.status.toLowerCase().replace(' ', '-');
            li.innerHTML = `<div class="pedido-info"><span>#${p.id} - ${p.cliente_nome || 'N/A'}</span><small>${p.cliente_endereco}, ${p.cliente_bairro || ''}</small></div><div style="display: flex; align-items: center; gap: 0.75rem;"><span class="pedido-qtd">🐔 ${totalFrangos}</span><span class="status status-${statusClass}">${p.status}</span></div>`;
            elements.allOrdersList.appendChild(li);
        });
    };
    
    const openDetailsModal = (motoqueiroId) => {
        if (modalPrazoInterval) clearInterval(modalPrazoInterval);
        const motoqueiro = activeMotoqueiros.find(m => m.id == motoqueiroId);
        if (!motoqueiro) return;
        const todosPedidosDoDia = [...motoqueiro.pedidos_em_rota, ...motoqueiro.pedidos_entregues];
        const totalVendas = todosPedidosDoDia.reduce((sum, p) => sum + (p.preco_total || 0), 0);
        const totalDinheiro = todosPedidosDoDia.filter(p => p.forma_pagamento === 'Dinheiro').reduce((sum, p) => sum + (p.preco_total || 0), 0);

        const frangosEntregues = motoqueiro.pedidos_entregues.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
        const frangosAtribuidos = motoqueiro.pedidos_em_rota.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
        const frangosDisponiveis = motoqueiro.frangos_na_bag - frangosAtribuidos - frangosEntregues;
        let squaresHtml = '';
        for(let i = 0; i < Math.floor(frangosEntregues); i++) { squaresHtml += `<div class="chicken-square square-delivered"></div>`; }
        for(let i = 0; i < Math.floor(frangosAtribuidos); i++) { squaresHtml += `<div class="chicken-square square-assigned"></div>`; }
        for(let i = 0; i < Math.floor(frangosDisponiveis); i++) { squaresHtml += `<div class="chicken-square square-available"></div>`; }
        
        elements.detailsModalHeader.innerHTML = `
            <div class="modal-header-details">
                <div class="modal-title-bar">
                    <h2 style="text-align: left; margin-bottom: 0;">${motoqueiro.nome}</h2>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-stats-grid">
                    <div class="modal-stat">
                        <div class="modal-stat-title">BAG</div>
                        <div class="modal-chicken-squares chicken-squares">${squaresHtml}</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-title">VENDAS TOTAIS</div>
                        <div class="modal-stat-value">R$ ${totalVendas.toFixed(2)}</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-title">TOTAL EM DINHEIRO</div>
                        <div class="modal-stat-value">R$ ${totalDinheiro.toFixed(2)}</div>
                    </div>
                </div>
            </div>`;
        
        elements.detailsPedidosList.innerHTML = '';
        if (motoqueiro.pedidos_em_rota.length > 0) {
            const rotaHeader = document.createElement('h3');
            rotaHeader.className = 'modal-section-header';
            rotaHeader.textContent = 'Em Rota (Arraste para ordenar)';
            elements.detailsPedidosList.appendChild(rotaHeader);

            const rotaListContainer = document.createElement('ul');
            rotaListContainer.id = 'rota-list'; 
            rotaListContainer.className = 'pedidos-list';

            // --- LÓGICA DE ORDENAÇÃO NO FRONTEND ---
            const sortedPedidos = motoqueiro.pedidos_em_rota.sort((a, b) => (a.rota_ordem || 999) - (b.rota_ordem || 999));

            sortedPedidos.forEach(p => {
                const li = document.createElement('li');
                li.className = 'pedido-item route-draggable';
                li.draggable = true;
                li.dataset.pedidoId = p.id;
                li.dataset.ordem = p.rota_ordem; // Adiciona o atributo data-ordem
                li.dataset.horarioPedido = p.horario_pedido;
                li.dataset.tempoPrevisto = p.tempo_previsto;
                const prazoHtml = calcularPrazo(p.horario_pedido, p.tempo_previsto);
                
                li.innerHTML = `
                    <div class="drag-handle">⠿</div>
                    <div class="pedido-card-content">
                        <div class="pedido-card-header">
                            <span class="cliente-nome">#${p.id} - ${p.cliente_nome || 'N/A'}</span>
                            <strong class="prazo-cell">${prazoHtml}</strong>
                        </div>
                        <div class="pedido-card-body">
                            <p class="endereco">${p.cliente_endereco || ''}, ${p.cliente_bairro || ''}</p>
                            <p class="telefone">📞 ${p.cliente_telefone || 'N/A'}</p>
                        </div>
                        <div class="pedido-card-footer">
                            <span class="pagamento">💳 ${p.forma_pagamento} - <strong>R$ ${p.preco_total ? p.preco_total.toFixed(2) : '0.00'}</strong></span>
                            <button class="action-btn entregar-btn" data-id="${p.id}">Entregue</button>
                        </div>
                    </div>
                `;
                rotaListContainer.appendChild(li);
            });
            elements.detailsPedidosList.appendChild(rotaListContainer);
        }
        
        if (motoqueiro.pedidos_entregues.length > 0) {
            const entreguesHeader = document.createElement('h3');
            entreguesHeader.className = 'modal-section-header';
            entreguesHeader.textContent = 'Entregues Hoje';
            elements.detailsPedidosList.appendChild(entreguesHeader);

            motoqueiro.pedidos_entregues.forEach(p => {
                const li = document.createElement('li');
                li.className = 'pedido-item card-entregue';
                li.innerHTML = `
                    <div class="delivered-icon">✓</div>
                    <div class="pedido-card-content">
                        <div class="pedido-card-header">
                            <span class="cliente-nome">#${p.id} - ${p.cliente_nome || 'N/A'}</span>
                            <strong class="prazo-cell">Finalizado</strong>
                        </div>
                        <div class="pedido-card-body">
                            <p class="endereco">${p.cliente_endereco || ''}, ${p.cliente_bairro || ''}</p>
                            <p class="telefone">📞 ${p.cliente_telefone || 'N/A'}</p>
                        </div>
                        <div class="pedido-card-footer">
                            <span class="pagamento">💳 ${p.forma_pagamento} - <strong>R$ ${p.preco_total ? p.preco_total.toFixed(2) : '0.00'}</strong></span>
                            <span class="status status-entregue">Entregue</span>
                        </div>
                    </div>
                `;
                elements.detailsPedidosList.appendChild(li);
            });
        }
        
        if (todosPedidosDoDia.length === 0) {
            elements.detailsPedidosList.innerHTML = '<div class="no-pedidos">Nenhum pedido atribuído hoje.</div>';
        }
        
        elements.detailsModalFooter.innerHTML = `
            <div class="modal-footer-actions">
                <button class="delete-motoqueiro-btn" data-id="${motoqueiro.id}">Excluir Motoqueiro</button>
                <button class="save-route-btn" data-id="${motoqueiro.id}">Salvar Rota</button>
            </div>`;
        elements.detailsModal.classList.remove('hidden');
        
        modalPrazoInterval = setInterval(() => {
            document.querySelectorAll('#details-pedidos-list .route-draggable').forEach(li => {
                const prazoCell = li.querySelector('.prazo-cell');
                if (prazoCell) {
                    prazoCell.innerHTML = calcularPrazo(li.dataset.horarioPedido, li.dataset.tempoPrevisto);
                }
            });
        }, 60000);
    };

    const handleStartDay = async (e) => {
        e.preventDefault();
        const motoqueiroNome = elements.motoqueiroNomeStart.value.trim();
        const frangosNaBag = parseFloat(elements.frangosNaBagStartInput.value);
        if (!motoqueiroNome || isNaN(frangosNaBag)) {
            alert('Preencha o nome e a quantidade de frangos.');
            return;
        }
        try {
            await fetchJSON(`${API_URL}/motoqueiros/operacao`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    motoqueiro_nome: motoqueiroNome, 
                    data: formatDateToYYYYMMDD(selectedDate),
                    frangos_na_bag: frangosNaBag 
                })
            });
            elements.startDayForm.reset();
            elements.startDayModal.classList.add('hidden');
            await refreshAllData();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        }
    };

    const handleAddOrRemoveChickens = async (e) => {
        e.preventDefault();
        const form = e.target;
        const motoqueiroNome = form.dataset.motoqueiroNome;
        const action = form.dataset.action;
        let amount = parseFloat(elements.adjustChickenAmountInput.value);

        if (isNaN(amount) || amount <= 0) {
            alert('Por favor, insira uma quantidade válida.');
            return;
        }

        if (action === 'remove') {
            amount = -amount;
        }

        try {
            await fetchJSON(`${API_URL}/motoqueiros/operacao`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    motoqueiro_nome: motoqueiroNome, 
                    data: formatDateToYYYYMMDD(selectedDate),
                    frangos_na_bag: amount 
                })
            });
            elements.adjustChickenModal.classList.add('hidden');
            await refreshAllData();
        } catch (error) {
            alert(`Erro ao ajustar frangos: ${error.message}`);
        }
    };
    
    const handleMarkAsDelivered = async (pedidoId) => { 
        if (confirm(`Confirmar a entrega do pedido #${pedidoId}?`)) { 
            try { 
                await fetchJSON(`${API_URL}/pedidos/${pedidoId}/entregar`, { method: 'PUT' }); 
                await refreshAllData();
                elements.detailsModal.classList.add('hidden'); 
            } catch (error) { 
                alert(`Erro ao finalizar entrega: ${error.message}`); 
            } 
        } 
    };

    const handleDeleteMotoqueiro = async (motoqueiroId) => { 
        if (confirm(`Tem certeza que deseja excluir este motoqueiro? Esta ação não pode ser desfeita.`)) { 
            try { 
                await fetchJSON(`${API_URL}/motoqueiros/${motoqueiroId}`, { method: 'DELETE' }); 
                await refreshAllData();
                elements.detailsModal.classList.add('hidden'); 
            } catch (error) { 
                alert(`Erro ao excluir motoqueiro: ${error.message}`); 
            } 
        } 
    };

    const handleSaveRoute = async (motoqueiroId) => {
        const orderedIds = [...document.querySelectorAll('#rota-list .route-draggable')].map(item => item.dataset.pedidoId);
        try {
            await fetchJSON(`${API_URL}/pedidos/ordenar-rota`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    ordem: orderedIds, 
                    motoqueiroId: motoqueiroId
                })
            });
            alert('Rota salva com sucesso!');
            elements.detailsModal.classList.add('hidden');
            await refreshAllData();
        } catch (error) {
            alert('Erro ao salvar a nova ordem da rota.');
            console.error(error);
        }
    };

    function setupDragAndDrop() {
        elements.allOrdersList.addEventListener('dragstart', e => { if (e.target.classList.contains('draggable')) { e.dataTransfer.setData('text/plain', JSON.stringify({ id: e.target.dataset.pedidoId, qtd: e.target.dataset.pedidoQtd })); setTimeout(() => e.target.classList.add('dragging'), 0); } });
        elements.allOrdersList.addEventListener('dragend', e => { if (e.target.classList.contains('draggable')) { e.target.classList.remove('dragging'); } });
        elements.motoqueirosList.addEventListener('dragover', e => { e.preventDefault(); const targetCard = e.target.closest('.motoqueiro-card'); if (targetCard) { targetCard.classList.add('drag-over'); } });
        elements.motoqueirosList.addEventListener('dragleave', e => { const targetCard = e.target.closest('.motoqueiro-card'); if (targetCard) { targetCard.classList.remove('drag-over'); } });
        elements.motoqueirosList.addEventListener('drop', async e => {
            e.preventDefault();
            const targetCard = e.target.closest('.motoqueiro-card');
            if (!targetCard) return;
            targetCard.classList.remove('drag-over');
            const motoqueiroId = targetCard.dataset.motoqueiroId;
            const pedidoData = JSON.parse(e.dataTransfer.getData('text/plain'));
            const pedidoId = pedidoData.id;
            const pedidoQtd = parseFloat(pedidoData.qtd);
            const motoqueiro = activeMotoqueiros.find(m => m.id == motoqueiroId);
            if (!motoqueiro) return;
            const frangosAtribuidos = motoqueiro.pedidos_em_rota.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const frangosEntregues = motoqueiro.pedidos_entregues.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const espacoLivre = motoqueiro.frangos_na_bag - frangosAtribuidos - frangosEntregues;
            if (espacoLivre >= pedidoQtd) {
                try {
                    await fetchJSON(`${API_URL}/pedidos/${pedidoId}/atribuir`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ motoqueiroId: motoqueiro.id }) });
                    await refreshAllData();
                } catch (error) { alert(`Erro ao atribuir pedido: ${error.message}`); }
            } else {
                alert(`Bag insuficiente! ${motoqueiro.nome} só tem ${espacoLivre} frangos livres.`);
            }
        });
    }

    // --- FUNCIONALIDADE DE REORDENAÇÃO REATIVADA ---
    function setupRouteReordering() {
        let draggedItem = null;
        
        elements.detailsPedidosList.addEventListener('dragstart', e => { 
            if (e.target.classList.contains('route-draggable')) { 
                draggedItem = e.target; 
                setTimeout(() => e.target.classList.add('dragging-route'), 0); 
            } 
        });

        elements.detailsPedidosList.addEventListener('dragend', e => { 
            if (draggedItem) { 
                draggedItem.classList.remove('dragging-route'); 
                draggedItem = null; 
            } 
        });

        elements.detailsPedidosList.addEventListener('dragover', e => {
            e.preventDefault();
            
            const list = e.target.closest('#rota-list');
            if (!list) {
                return;
            }
            
            const afterElement = getDragAfterElement(list, e.clientY);
            if(draggedItem) {
                if (afterElement == null) { 
                    list.appendChild(draggedItem); 
                } else { 
                    list.insertBefore(draggedItem, afterElement); 
                }
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.route-draggable:not(.dragging-route)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { 
                    return { offset: offset, element: child }; 
                } else { 
                    return closest; 
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    }

    const fetchDataForDate = async (date) => {
        const dateString = formatDateToYYYYMMDD(date);
        updateDateDisplay();
        try {
            const [motoqueiros, pedidos] = await Promise.all([
                fetchJSON(`${API_URL}/motoqueiros/detalhes?data=${dateString}`),
                fetchJSON(`${API_URL}/pedidos?data=${dateString}`)
            ]);
            activeMotoqueiros = motoqueiros || [];
            allPedidos = pedidos || [];
            renderMotoqueiros();
            renderAllPedidos();
        } catch (error) {
            console.error("Erro ao buscar dados do dia:", error);
            activeMotoqueiros = [];
            try {
                allPedidos = await fetchJSON(`${API_URL}/pedidos?data=${dateString}`);
            } catch (pedidosError) {
                console.error("Erro ao buscar apenas os pedidos:", pedidosError);
                allPedidos = [];
            }
            renderMotoqueiros();
            renderAllPedidos();
        }
    };

    const populateMasterMotoqueiros = async () => {
        try {
            masterMotoqueiros = await fetchJSON(`${API_URL}/motoqueiros`);
            const options = masterMotoqueiros.map(m => `<option value="${m.nome}"></option>`).join('');
            elements.motoqueirosDatalist.innerHTML = options;
        } catch (error) {
            console.error("Erro ao carregar lista de motoqueiros:", error);
        }
    };
    
    const refreshAllData = async () => {
        await populateMasterMotoqueiros();
        await fetchDataForDate(selectedDate);
    };

    const changeDate = (days) => {
        selectedDate.setDate(selectedDate.getDate() + days);
        fetchDataForDate(selectedDate);
    };

    function setupEventListeners() {
        elements.openStartDayModalBtn.addEventListener('click', () => elements.startDayModal.classList.remove('hidden'));
        elements.closeStartDayModalBtn.addEventListener('click', () => elements.startDayModal.classList.add('hidden'));
        elements.startDayModal.addEventListener('click', (e) => { if (e.target === elements.startDayModal) elements.startDayModal.classList.add('hidden'); });
        elements.startDayForm.addEventListener('submit', handleStartDay);

        elements.closeAdjustChickenModalBtn.addEventListener('click', () => elements.adjustChickenModal.classList.add('hidden'));
        elements.adjustChickenModal.addEventListener('click', (e) => { if (e.target === elements.adjustChickenModal) elements.adjustChickenModal.classList.add('hidden'); });
        elements.adjustChickenForm.addEventListener('submit', handleAddOrRemoveChickens);

        elements.prevDayBtn.addEventListener('click', () => changeDate(-1));
        elements.nextDayBtn.addEventListener('click', () => changeDate(1));
        
        elements.searchPedidosInput.addEventListener('input', (e) => { 
            renderAllPedidos(e.target.value);
        });
        
        elements.detailsModal.addEventListener('click', (e) => { 
            if (e.target === elements.detailsModal || e.target.closest('.close-btn')) {
                elements.detailsModal.classList.add('hidden');
                clearInterval(modalPrazoInterval);
            }
        });
        
        elements.motoqueirosList.addEventListener('click', (e) => { 
            const cardElement = e.target.closest('.motoqueiro-card');
            const adjustButton = e.target.closest('.adjust-btn');

            if (adjustButton) {
                const motoqueiroNome = adjustButton.dataset.motoqueiroNome;
                const action = adjustButton.dataset.action;
                elements.adjustModalTitle.textContent = action === 'add' ? `Adicionar Frangos para ${motoqueiroNome}` : `Remover Frangos de ${motoqueiroNome}`;
                elements.adjustChickenForm.dataset.motoqueiroNome = motoqueiroNome;
                elements.adjustChickenForm.dataset.action = action;
                elements.adjustChickenAmountInput.value = '';
                elements.adjustChickenModal.classList.remove('hidden');
            } else if (cardElement) {
                openDetailsModal(cardElement.dataset.motoqueiroId);
            }
        });

        elements.detailsPedidosList.addEventListener('click', (e) => { 
            if (e.target.classList.contains('entregar-btn')) handleMarkAsDelivered(e.target.dataset.id); 
        });
        
        elements.detailsModalFooter.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-motoqueiro-btn')) {
                handleDeleteMotoqueiro(e.target.dataset.id);
            }
            if (e.target.classList.contains('save-route-btn')) {
                handleSaveRoute(e.target.dataset.id);
            }
        });

        elements.logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    async function initializePage() {
        setupEventListeners();
        setupDragAndDrop();
        setupRouteReordering(); // Reativado
        await refreshAllData();
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>

</body>
</html>
