<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Entregas - Frangolândia</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root { --primary-color: #4299e1; }
    .page-container { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: start; }
    .motoqueiros-panel, .orders-panel { display: flex; flex-direction: column; gap: 1.5rem; }
    .motoqueiro-card { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out; }
    .card-header { padding: 1rem 1.5rem; background-color: #f7fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .card-header h3 { font-size: 1.25rem; cursor: pointer; }
    .card-body { padding: 1.5rem; }
    .chicken-squares { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 1rem; }
    .chicken-square { width: 20px; height: 20px; border-radius: 4px; }
    .square-delivered { background-color: #48bb78; }
    .square-assigned { background-color: #947703; }
    .square-available { background-color: #f59e0b; }
    .add-motoqueiro-card { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 1.5rem; }
    .add-forms-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .orders-panel .pedidos-container { max-height: 80vh; overflow-y: auto; }
    .pedidos-list { list-style: none; padding: 0; }
    .pedido-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e2e8f0; }
    .pedido-item:last-child { border-bottom: none; }
    .pedido-info { display: flex; flex-direction: column; }
    .pedido-info span { font-weight: 600; }
    .pedido-info small { color: #718096; }
    .pedido-qtd { font-weight: bold; color: #4a5568; }
    .entregar-btn { background-color: #48bb78; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
    .entregar-btn:hover { background-color: #38a169; }
    .no-pedidos { text-align: center; color: #718096; padding: 2rem; }
    #details-modal .form-container { max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
    .modal-header-details { padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
    #details-pedidos-list { overflow-y: auto; flex-grow: 1; padding: 0 2rem; }
    .modal-title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .modal-stats-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    .modal-stat { background-color: #f8fafc; padding: 0.75rem; border-radius: 8px; }
    .modal-stat-title { font-size: 0.8rem; color: #718096; margin-bottom: 0.25rem; }
    .modal-stat-value { font-size: 1.2rem; font-weight: 600; }
    .modal-chicken-squares .chicken-square { width: 15px; height: 15px; }
    .pedido-item.route-draggable { cursor: grab; }
    .pedido-item.route-draggable:active { cursor: grabbing; }
    .pedido-item.dragging-route { opacity: 0.4; }
    .modal-footer-actions { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: #f7fafc; border-top: 1px solid #e2e8f0; flex-shrink: 0; }
    .delete-motoqueiro-btn { background-color: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
    .delete-motoqueiro-btn:hover { background-color: #dc2626; }
    .save-route-btn { background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
    .save-route-btn:hover { background-color: #3182ce; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="index.html">Painel de Pedidos</a>
      <a href="motoqueiros.html" class="active">Painel de Entregas</a>
    </nav>
    <div class="info-header" style="justify-content: center;">
        <div class="date-navigator">
            <button id="prev-day-btn" class="date-nav-btn">&lt;</button>
            <span id="current-date-display"></span>
            <button id="next-day-btn" class="date-nav-btn">&gt;</button>
        </div>
    </div>
  </header>

  <main class="page-container">
    <div id="motoqueiros-list" class="motoqueiros-panel">
        <div class="add-motoqueiro-card">
            <div class="add-forms-container">
                <form id="start-day-form" class="form-container" style="padding:0; box-shadow:none; max-height: none; display: block;">
                    <h2>Iniciar Dia / Adicionar Frangos</h2>
                    <div class="form-grid-container" style="grid-template-columns: 2fr 1fr;">
                        <div class="form-field">
                            <label for="motoqueiro-nome-start">Nome do Motoqueiro</label>
                            <input type="text" id="motoqueiro-nome-start" list="motoqueiros-datalist" placeholder="Digite ou selecione" required>
                            <datalist id="motoqueiros-datalist"></datalist>
                        </div>
                        <div class="form-field">
                            <label for="frangos-na-bag">Frangos na Bag</label>
                            <input type="number" id="frangos-na-bag" min="0" step="0.5" required>
                        </div>
                    </div>
                    <button type="submit">Iniciar / Adicionar</button>
                </form>
            </div>
        </div>
    </div>

    <div class="orders-panel">
        <div class="pedidos-container">
            <h2>Pedidos do Dia</h2>
            <div class="form-field"><input type="text" id="search-pedidos" placeholder="Pesquisar por cliente ou bairro..."></div>
            <ul id="all-orders-list" class="pedidos-list"></ul>
        </div>
    </div>
  </main>

  <div id="details-modal" class="modal-container hidden">
    <section class="form-container">
        <button id="close-details-modal" class="close-btn">&times;</button>
        <div id="details-modal-header"></div>
        <ul id="details-pedidos-list" class="pedidos-list"></ul>
        <div id="details-modal-footer"></div>
    </section>
  </div>

  <script>
    const API_URL = '/api';
    let selectedDate = new Date();
    let allPedidos = [];
    let activeMotoqueiros = []; 
    let masterMotoqueiros = []; 

    const elements = {
        motoqueirosList: document.getElementById('motoqueiros-list'),
        allOrdersList: document.getElementById('all-orders-list'),
        startDayForm: document.getElementById('start-day-form'),
        motoqueiroNomeStart: document.getElementById('motoqueiro-nome-start'),
        motoqueirosDatalist: document.getElementById('motoqueiros-datalist'),
        frangosNaBagInput: document.getElementById('frangos-na-bag'),
        searchPedidosInput: document.getElementById('search-pedidos'),
        detailsModal: document.getElementById('details-modal'),
        closeDetailsModalBtn: document.getElementById('close-details-modal'),
        detailsModalHeader: document.getElementById('details-modal-header'),
        detailsPedidosList: document.getElementById('details-pedidos-list'),
        detailsModalFooter: document.getElementById('details-modal-footer'),
        currentDateDisplay: document.getElementById('current-date-display'),
        prevDayBtn: document.getElementById('prev-day-btn'),
        nextDayBtn: document.getElementById('next-day-btn'),
    };

    const formatDateToYYYYMMDD = (date) => date.toISOString().slice(0, 10);
    const formatDisplayDate = (date) => { const today = new Date(); return formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(today) ? "Hoje" : date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }); };
    const updateDateDisplay = () => { elements.currentDateDisplay.textContent = formatDisplayDate(selectedDate); };
    const fetchJSON = async (url, options = {}) => { const response = await fetch(url, options); if (!response.ok) { const errorData = await response.json().catch(() => ({ error: 'Erro de comunicação' })); throw new Error(errorData.error); } const text = await response.text(); return text ? JSON.parse(text) : { message: 'Operação bem-sucedida' }; };

    const renderMotoqueiros = () => {
        document.querySelectorAll('.motoqueiro-card').forEach(card => card.remove());
        activeMotoqueiros.forEach(m => {
            const card = document.createElement('div');
            card.className = 'motoqueiro-card';
            card.dataset.motoqueiroId = m.id;
            const frangosEntregues = m.pedidos_entregues.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const frangosAtribuidos = m.pedidos_em_rota.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const frangosDisponiveis = m.frangos_na_bag - frangosAtribuidos - frangosEntregues;
            let squaresHtml = '';
            for(let i = 0; i < Math.floor(frangosEntregues); i++) { squaresHtml += `<div class="chicken-square square-delivered"></div>`; }
            for(let i = 0; i < Math.floor(frangosAtribuidos); i++) { squaresHtml += `<div class="chicken-square square-assigned"></div>`; }
            for(let i = 0; i < Math.floor(frangosDisponiveis); i++) { squaresHtml += `<div class="chicken-square square-available"></div>`; }
            card.innerHTML = `<div class="card-header"><h3 class="motoqueiro-name" data-id="${m.id}">${m.nome}</h3></div><div class="card-body"><strong>Bag: ${frangosAtribuidos + frangosEntregues} / ${m.frangos_na_bag} frangos</strong><div class="chicken-squares">${squaresHtml}</div></div>`;
            elements.motoqueirosList.appendChild(card);
        });
    };

    const renderAllPedidos = (pedidos) => {
        elements.allOrdersList.innerHTML = '';
        const deliveryOrders = pedidos.filter(p => p.cliente_endereco !== 'Retirada');
        if (deliveryOrders.length === 0) {
            elements.allOrdersList.innerHTML = '<div class="no-pedidos">Nenhum pedido de entrega para hoje.</div>';
            return;
        }
        deliveryOrders.forEach(p => {
            const li = document.createElement('li');
            const isDraggable = p.status === 'Pendente';
            li.className = `pedido-item ${isDraggable ? 'draggable' : ''}`;
            li.draggable = isDraggable;
            li.dataset.pedidoId = p.id;
            const totalFrangos = p.quantidade_frangos + (p.meio_frango ? 0.5 : 0);
            li.dataset.pedidoQtd = totalFrangos;
            const statusClass = p.status.toLowerCase().replace(' ', '-');
            li.innerHTML = `<div class="pedido-info"><span>#${p.id} - ${p.cliente_nome || 'N/A'}</span><small>${p.cliente_endereco}, ${p.cliente_bairro || ''}</small></div><div style="display: flex; align-items: center; gap: 0.75rem;"><span class="pedido-qtd">🐔 ${totalFrangos}</span><span class="status status-${statusClass}">${p.status}</span></div>`;
            elements.allOrdersList.appendChild(li);
        });
    };
    
    const openDetailsModal = (motoqueiroId) => {
        const motoqueiro = activeMotoqueiros.find(m => m.id == motoqueiroId);
        if (!motoqueiro) return;
        const todosPedidosDoDia = [...motoqueiro.pedidos_em_rota, ...motoqueiro.pedidos_entregues];
        const totalVendas = todosPedidosDoDia.reduce((sum, p) => sum + p.preco_total, 0);
        const totalDinheiro = todosPedidosDoDia.filter(p => p.forma_pagamento === 'Dinheiro').reduce((sum, p) => sum + p.preco_total, 0);
        const frangosEntregues = motoqueiro.pedidos_entregues.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
        const frangosAtribuidos = motoqueiro.pedidos_em_rota.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
        const frangosDisponiveis = motoqueiro.frangos_na_bag - frangosAtribuidos - frangosEntregues;
        let squaresHtml = '';
        for(let i = 0; i < Math.floor(frangosEntregues); i++) { squaresHtml += `<div class="chicken-square square-delivered"></div>`; }
        for(let i = 0; i < Math.floor(frangosAtribuidos); i++) { squaresHtml += `<div class="chicken-square square-assigned"></div>`; }
        for(let i = 0; i < Math.floor(frangosDisponiveis); i++) { squaresHtml += `<div class="chicken-square square-available"></div>`; }
        elements.detailsModalHeader.innerHTML = `
            <div class="modal-header-details">
                <div class="modal-title-bar">
                    <h2 style="text-align: left; margin-bottom: 0;">${motoqueiro.nome}</h2>
                </div>
                <div class="modal-stats-grid">
                    <div class="modal-stat">
                        <div class="modal-stat-title">BAG</div>
                        <div class="modal-chicken-squares chicken-squares">${squaresHtml}</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-title">VENDAS TOTAIS</div>
                        <div class="modal-stat-value">R$ ${totalVendas.toFixed(2)}</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-title">TOTAL EM DINHEIRO</div>
                        <div class="modal-stat-value">R$ ${totalDinheiro.toFixed(2)}</div>
                    </div>
                </div>
            </div>`;
        elements.detailsPedidosList.innerHTML = '';
        if (motoqueiro.pedidos_em_rota.length > 0) {
            const rotaHeader = document.createElement('h3');
            rotaHeader.className = 'modal-section-header';
            rotaHeader.textContent = 'Em Rota (Arraste para ordenar)';
            elements.detailsPedidosList.appendChild(rotaHeader);
            motoqueiro.pedidos_em_rota.forEach(p => {
                const li = document.createElement('li');
                li.className = 'pedido-item route-draggable';
                li.draggable = true;
                li.dataset.pedidoId = p.id;
                li.innerHTML = `<div class="pedido-info-detailed"><div class="detailed-info-header"><span>#${p.id} - ${p.cliente_nome || 'N/A'}</span><strong>R$ ${p.preco_total ? p.preco_total.toFixed(2) : '0.00'}</strong></div><small class="detailed-info-address">${p.cliente_endereco}, ${p.cliente_bairro || ''}</small><div class="detailed-info-footer"><small>📞 ${p.cliente_telefone || 'N/A'}</small><small>💳 ${p.forma_pagamento}</small></div></div><button class="entregar-btn" data-id="${p.id}">Entregue</button>`;
                elements.detailsPedidosList.appendChild(li);
            });
        }
        if (motoqueiro.pedidos_entregues.length > 0) {
            const entreguesHeader = document.createElement('h3');
            entreguesHeader.className = 'modal-section-header';
            entreguesHeader.textContent = 'Entregues Hoje';
            elements.detailsPedidosList.appendChild(entreguesHeader);
            motoqueiro.pedidos_entregues.forEach(p => {
                const li = document.createElement('li');
                li.className = 'pedido-item pedido-entregue-modal';
                li.innerHTML = `<div class="pedido-info-detailed"><div class="detailed-info-header"><span>#${p.id} - ${p.cliente_nome || 'N/A'}</span><strong>R$ ${p.preco_total ? p.preco_total.toFixed(2) : '0.00'}</strong></div><small class="detailed-info-address">${p.cliente_endereco}, ${p.cliente_bairro || ''}</small><div class="detailed-info-footer"><small>📞 ${p.cliente_telefone || 'N/A'}</small><small>💳 ${p.forma_pagamento}</small></div></div><span class="status status-entregue">Entregue</span>`;
                elements.detailsPedidosList.appendChild(li);
            });
        }
        if (todosPedidosDoDia.length === 0) {
            elements.detailsPedidosList.innerHTML = '<div class="no-pedidos">Nenhum pedido atribuído hoje.</div>';
        }
        elements.detailsModalFooter.innerHTML = `
            <div class="modal-footer-actions">
                <button class="delete-motoqueiro-btn" data-id="${motoqueiro.id}">Excluir Motoqueiro</button>
                <button class="save-route-btn" data-id="${motoqueiro.id}">Salvar Rota</button>
            </div>`;
        elements.detailsModal.classList.remove('hidden');
    };

    const handleStartDay = async (e) => {
        e.preventDefault();
        const motoqueiroNome = elements.motoqueiroNomeStart.value.trim();
        const frangosNaBag = parseFloat(elements.frangosNaBagInput.value);
        if (!motoqueiroNome || isNaN(frangosNaBag)) {
            alert('Preencha o nome do motoqueiro e a quantidade de frangos.');
            return;
        }
        try {
            await fetchJSON(`${API_URL}/motoqueiros/operacao`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    motoqueiro_nome: motoqueiroNome, 
                    data: formatDateToYYYYMMDD(selectedDate),
                    frangos_na_bag: frangosNaBag 
                })
            });
            elements.startDayForm.reset();
            fetchDataForDate(selectedDate);
            populateMasterMotoqueiros();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        }
    };
    
    const handleMarkAsDelivered = async (pedidoId) => { if (confirm(`Confirmar a entrega do pedido #${pedidoId}?`)) { try { await fetchJSON(`${API_URL}/pedidos/${pedidoId}/entregar`, { method: 'PUT' }); init(); elements.detailsModal.classList.add('hidden'); } catch (error) { alert(`Erro ao finalizar entrega: ${error.message}`); } } };
    const handleDeleteMotoqueiro = async (motoqueiroId) => { if (confirm(`Tem certeza que deseja excluir este motoqueiro? Esta ação não pode ser desfeita.`)) { try { await fetchJSON(`${API_URL}/motoqueiros/${motoqueiroId}`, { method: 'DELETE' }); init(); elements.detailsModal.classList.add('hidden'); } catch (error) { alert(`Erro ao excluir motoqueiro: ${error.message}`); } } };
    const handleSaveRoute = async () => {
        const orderedIds = [...elements.detailsPedidosList.querySelectorAll('.route-draggable')].map(item => item.dataset.pedidoId);
        try {
            await fetchJSON(`${API_URL}/pedidos/ordenar-rota`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ordem: orderedIds })
            });
            alert('Rota salva com sucesso!');
            elements.detailsModal.classList.add('hidden');
            init();
        } catch (error) {
            alert('Erro ao salvar a nova ordem da rota.');
            console.error(error);
        }
    };

    function setupDragAndDrop() {
        elements.allOrdersList.addEventListener('dragstart', e => { if (e.target.classList.contains('draggable')) { e.dataTransfer.setData('text/plain', JSON.stringify({ id: e.target.dataset.pedidoId, qtd: e.target.dataset.pedidoQtd })); setTimeout(() => e.target.classList.add('dragging'), 0); } });
        elements.allOrdersList.addEventListener('dragend', e => { if (e.target.classList.contains('draggable')) { e.target.classList.remove('dragging'); } });
        elements.motoqueirosList.addEventListener('dragover', e => { e.preventDefault(); const targetCard = e.target.closest('.motoqueiro-card'); if (targetCard) { targetCard.classList.add('drag-over'); } });
        elements.motoqueirosList.addEventListener('dragleave', e => { const targetCard = e.target.closest('.motoqueiro-card'); if (targetCard) { targetCard.classList.remove('drag-over'); } });
        elements.motoqueirosList.addEventListener('drop', async e => {
            e.preventDefault();
            const targetCard = e.target.closest('.motoqueiro-card');
            if (!targetCard) return;
            targetCard.classList.remove('drag-over');
            const motoqueiroId = targetCard.dataset.motoqueiroId;
            const pedidoData = JSON.parse(e.dataTransfer.getData('text/plain'));
            const pedidoId = pedidoData.id;
            const pedidoQtd = parseFloat(pedidoData.qtd);
            const motoqueiro = activeMotoqueiros.find(m => m.id == motoqueiroId);
            if (!motoqueiro) return;
            const frangosAtribuidos = motoqueiro.pedidos_em_rota.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const frangosEntregues = motoqueiro.pedidos_entregues.reduce((sum, p) => sum + p.quantidade_frangos + (p.meio_frango ? 0.5 : 0), 0);
            const espacoLivre = motoqueiro.frangos_na_bag - frangosAtribuidos - frangosEntregues;
            if (espacoLivre >= pedidoQtd) {
                try {
                    await fetchJSON(`${API_URL}/pedidos/${pedidoId}/atribuir`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ motoqueiroId: motoqueiro.id }) });
                    init();
                } catch (error) { alert(`Erro ao atribuir pedido: ${error.message}`); }
            } else {
                alert(`Bag insuficiente! ${motoqueiro.nome} só tem ${espacoLivre} frangos livres.`);
            }
        });
    }

    function setupRouteReordering() {
        let draggedItem = null;
        elements.detailsPedidosList.addEventListener('dragstart', e => { if (e.target.classList.contains('route-draggable')) { draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging-route'), 0); } });
        elements.detailsPedidosList.addEventListener('dragend', e => { if (draggedItem) { draggedItem.classList.remove('dragging-route'); draggedItem = null; } });
        elements.detailsPedidosList.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(elements.detailsPedidosList, e.clientY);
            const list = e.target.closest('.pedidos-list');
            if(draggedItem) {
                if (afterElement == null) { list.appendChild(draggedItem); } 
                else { list.insertBefore(draggedItem, afterElement); }
            }
        });
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.route-draggable:not(.dragging-route)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    }

    const fetchDataForDate = async (date) => {
        const dateString = formatDateToYYYYMMDD(date);
        updateDateDisplay();
        try {
            const [motoqueiros, pedidos] = await Promise.all([
                fetchJSON(`${API_URL}/motoqueiros/detalhes?data=${dateString}`),
                fetchJSON(`${API_URL}/pedidos?data=${dateString}`)
            ]);
            activeMotoqueiros = motoqueiros;
            allPedidos = pedidos;
            renderMotoqueiros();
            renderAllPedidos(allPedidos);
        } catch (error) {
            console.error("Erro ao buscar dados do dia:", error);
            activeMotoqueiros = [];
            allPedidos = [];
            renderMotoqueiros();
            renderAllPedidos([]);
        }
    };

    const populateMasterMotoqueiros = async () => {
        try {
            masterMotoqueiros = await fetchJSON(`${API_URL}/motoqueiros`);
            const options = masterMotoqueiros.map(m => `<option value="${m.nome}"></option>`).join('');
            elements.motoqueirosDatalist.innerHTML = options;
        } catch (error) {
            console.error("Erro ao carregar lista de motoqueiros:", error);
        }
    };

    const changeDate = (days) => {
        selectedDate.setDate(selectedDate.getDate() + days);
        fetchDataForDate(selectedDate);
    };

    function setupEventListeners() {
        elements.startDayForm.addEventListener('submit', handleStartDay);
        elements.prevDayBtn.addEventListener('click', () => changeDate(-1));
        elements.nextDayBtn.addEventListener('click', () => changeDate(1));
        elements.searchPedidosInput.addEventListener('input', (e) => { 
            const term = e.target.value.toLowerCase(); 
            const filtered = allPedidos.filter(p => (p.cliente_nome && p.cliente_nome.toLowerCase().includes(term)) || (p.cliente_bairro && p.cliente_bairro.toLowerCase().includes(term))); 
            renderAllPedidos(filtered); 
        });
        elements.closeDetailsModalBtn.addEventListener('click', () => elements.detailsModal.classList.add('hidden'));
        elements.detailsModal.addEventListener('click', (e) => { 
            if (e.target === elements.detailsModal) elements.detailsModal.classList.add('hidden');
        });
        elements.motoqueirosList.addEventListener('click', (e) => { 
            if (e.target.classList.contains('motoqueiro-name')) openDetailsModal(e.target.dataset.id); 
        });
        elements.detailsPedidosList.addEventListener('click', (e) => { 
            if (e.target.classList.contains('entregar-btn')) handleMarkAsDelivered(e.target.dataset.id); 
        });
        elements.detailsModalFooter.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-motoqueiro-btn')) handleDeleteMotoqueiro(e.target.dataset.id);
            if (e.target.classList.contains('save-route-btn')) handleSaveRoute();
        });
    }

    async function init() {
        await populateMasterMotoqueiros();
        await fetchDataForDate(selectedDate);
        setupEventListeners();
        setupDragAndDrop();
        setupRouteReordering();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>

</body>
</html>
